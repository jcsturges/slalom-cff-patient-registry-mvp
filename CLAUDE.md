# NGR MVP — Claude Code Configuration

## Project Overview

MVP artifacts for the **Next Generation Patient Registry (NGR)** for the **Cystic Fibrosis Foundation (CFF)**. Generated by a 5-stage AI pipeline (BA → Architect → Engineer → QA → DevOps) built on AWS Bedrock AgentCore. The AWS AgentCore pipeline run ID was `271c9944-1e04-4d3d-91b9-9c0d9b99a354` for initial generation.

Key docs live in `prd/`, `architecture/`, and `iac/runbook.md`.

---

## Tech Stack (MANDATORY — dictated by CFF RFP)

| Layer | Technology |
|-------|-----------|
| Frontend | React 18 TypeScript SPA (Vite, Material-UI) |
| API | ASP.NET Core 8 Web API (C# 12) |
| Database | Azure SQL Database (EF Core 8) |
| Auth | Okta (OIDC/SAML, JWT Bearer) |
| Hosting | Azure App Services (Linux) |
| CI/CD | Azure DevOps YAML Pipelines |
| E2E Testing | Playwright (TypeScript) |
| Unit Testing | xUnit (.NET) |
| IaC | Terraform (hashicorp/azurerm ~> 3.85) |
| Monitoring | Azure Application Insights |
| Secrets | Azure Key Vault |

**Do not deviate from this stack.** Tech choices were specified by CFF in their RFP appendices.

---

## Key Paths

```
prd/                     # PRD, user stories, acceptance criteria
architecture/            # System design, API spec, ADRs, data model
src/ngr-api/             # ASP.NET Core 8 REST API
src/ngr-web-app/         # React 18 TypeScript SPA
src/ngr-database/        # EF Core entities, DbContext, migrations
tests/                   # xUnit test suite
iac/terraform/           # Azure infrastructure (Terraform)
iac/cicd/                # Azure DevOps pipeline YAML
iac/dockerfiles/         # Dockerfiles for API + Web
iac/docker-compose.yml   # Local dev environment
iac/runbook.md           # Operations runbook
```

---

## Documentation Requirement

**Every feature change or code addition must update documentation.** This is non-negotiable:

- UI feature added or changed → update `README.md`
- API endpoint or auth rule added or changed → update `README.md` and `CLAUDE.md`
- Key path, convention, or limitation changed → update `CLAUDE.md`
- New service, hook, or component introduced → note it in `CLAUDE.md` under Architecture Conventions

---

## RBAC UI Convention

**Buttons and actions gated by role must be disabled (never hidden) when the user lacks permission.** A `Tooltip` must explain why.

- Use `RoleGatedButton` (`src/ngr-web-app/src/components/RoleGatedButton.tsx`) for all role-gated actions.
- Use the `useRoles` hook (`src/ngr-web-app/src/hooks/useRoles.ts`) to read permissions from the Okta access token.
- For page-level access (e.g., navigating directly to `/patients/new` without the role), render an `<Alert severity="error">` explaining the required role.
- `useRoles` mirrors the server-side policies in `Program.cs` exactly. When adding new policies, update both.

---

## Architecture Conventions

- **API pattern:** RESTful (not GraphQL). Controllers → Services → EF Core DbContext.
- **Namespaces:** All C# code uses `NgrApi.*` (e.g., `NgrApi.Models`, `NgrApi.Services`). **Not** `NGR.Api.*`.
- **Database schema:** SQL migration scripts use the `ngr` schema. The EF Core `ApplicationDbContext` uses `dbo`. In local dev, `EnsureCreated()` auto-creates tables in `dbo`.
- **Auth flow:** Okta OIDC → JWT Bearer tokens. 4 roles: `SystemAdmin`, `FoundationAnalyst`, `ProgramAdmin`, `ClinicalUser`.
- **Session management:** `api.ts` detects 401 responses and redirects to Okta login with `originalUri`. `useSessionMonitor` hook listens to tokenManager `expired`/`error` events for proactive detection. Both preserve the current URL for post-login restore.
- **User sync:** `POST /api/auth/sync` (`AuthController.cs`) upserts user profile from JWT claims on login. Called by `useUserSync` hook in `Layout.tsx`.
- **Care Programs:** `ProgramsController` (FoundationAnalyst policy) — POST/GET/PUT, no DELETE (programs are deactivated, never deleted). `ProgramId` is an immutable, manually-assigned integer. ORH program (ID 3000) is seeded automatically. Training programs have `IsTrainingProgram` flag for analytics exclusion.
- **Program-User Associations:** `UserProgramRole` model tracks per-program role assignments with `Status` (Active/Deactivated). Foundation Admins manage via Programs UI.
- **Audit logging:** `AuditService.LogActionAsync()` records entity changes with old/new values, timestamp, acting user. Used by `ProgramService` for create/update/deactivate events.
- **Form engine:** Dynamic eCRF rendering from JSON schema definitions stored in the `FormDefinitions` table.
- **CORS:** Configured via `Cors:AllowedOrigins` in appsettings.
- **Secrets:** All connection strings and credentials go through Azure Key Vault. Local dev uses User Secrets or docker-compose environment variables.
- **Logging:** Serilog → Console. Application Insights sink is conditional (only enabled when connection string is configured).
- **HTTPS redirect:** Disabled in Development mode to avoid redirect loops in Docker.

---

## Local Development

```bash
# From iac/
docker-compose up --build -d
```

| Service | URL | Notes |
|---------|-----|-------|
| **Azure SQL Edge** | `localhost:1433` | ARM64-native; sa / `Dev!Password123`; DB: `PatientRegistryDev` |
| **ASP.NET Core API** | `http://localhost:5000` | Swagger UI at `/swagger`; health at `/health` |
| **React SPA** | `http://localhost:3000` | nginx serving Vite build on port 8080 internally |

- Tables are **auto-created** via EF Core `EnsureCreated()` in dev — no manual SQL migration needed.
- Apple Silicon (M-series): Uses Azure SQL Edge instead of SQL Server 2022 (amd64-only).
- `VITE_*` env vars are baked at Docker build time via build `args`, not runtime `environment`.

---

## Known Limitations

- **Test coverage is thin** — 1 xUnit test file; needs expansion to 70%+
- **Business rules are approximated** — Form engine, ownership/sharing rules, and RBAC need refinement against Appendix A/C/E
- **Data migration is not implemented** — PortCF ETL is out of scope
- **Form specs are stubbed** — Real eCRF machine-readable specs from CFF required
- **Secrets are placeholder** — All connection strings use placeholder values
- **Dual DbContext** — `ApplicationDbContext` (API, 14 entities, `dbo`) vs `NgrDbContext` (database project, 21 entities, `ngr`). The API uses `ApplicationDbContext`.
- **EF/SQL schema mismatch** — Raw SQL scripts create tables in `ngr`; EF Core creates in `dbo`. Use `EnsureCreated()` for local dev only.
- **Azure.Identity 1.10.4** — Has known moderate security vulnerabilities (pinned by AI pipeline). Upgrade before production.

---

## Workflow

- Before any non-trivial task, write a plan to `tasks/todo.md` with checkable items and check in before implementing.
- Mark items complete as you go; add a summary section when done.
- After any correction from the user, update `tasks/lessons.md` with the pattern to prevent recurrence.
- Never mark a task complete without demonstrating it works — run tests, check logs, verify behavior.
