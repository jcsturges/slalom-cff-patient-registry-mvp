# PatientRegistry — Local Development Stack
# Usage: docker compose up --build
# Prerequisites: Docker Desktop, valid Okta dev credentials in .env.local

version: "3.8"

services:

  # ── Azure SQL Edge (ARM64-compatible SQL Server for Apple Silicon) ─────────
  sql:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      SA_PASSWORD: "Dev!Password123"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
    ports:
      - "1433:1433"
    volumes:
      - sql_data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/1433' 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      start_period: 20s
      retries: 10

  # ── NGR API (ASP.NET Core 8) ───────────────────────────────────────────────
  api:
    build:
      context: ../src/ngr-api
      dockerfile: ../../iac/dockerfiles/api.Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: >-
        Server=sql,1433;
        Database=PatientRegistryDev;
        User Id=sa;
        Password=Dev!Password123;
        TrustServerCertificate=True;
        MultipleActiveResultSets=True
      Okta__Authority: "${OKTA_AUTHORITY:-https://dev-12345.okta.com/oauth2/default}"
      Okta__Audience: "${OKTA_AUDIENCE:-api://default}"
      KeyVault__VaultUri: ""          # Disabled locally; secrets come from env
      ApplicationInsights__ConnectionString: ""
      Cors__AllowedOrigins__0: "http://localhost:3000"
    ports:
      - "5000:8080"
    depends_on:
      sql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/health"]
      interval: 15s
      timeout: 10s
      start_period: 30s
      retries: 5

  # ── NGR Web App (React 18 / Vite → nginx) ─────────────────────────────────
  web-app:
    build:
      context: ../src/ngr-web-app
      dockerfile: ../../iac/dockerfiles/web-app.Dockerfile
      args:
        VITE_API_URL: "http://localhost:5000"
        VITE_OKTA_ISSUER: "${OKTA_AUTHORITY:-https://dev-12345.okta.com/oauth2/default}"
        VITE_OKTA_CLIENT_ID: "${OKTA_CLIENT_ID:-CLIENT1234567890}"
        VITE_OKTA_REDIRECT_URI: "http://localhost:3000/login/callback"
    ports:
      - "3000:8080"
    depends_on:
      api:
        condition: service_healthy

volumes:
  sql_data:
    name: ngr-sql-dev-data
